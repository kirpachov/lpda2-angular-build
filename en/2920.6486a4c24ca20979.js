(self.webpackChunklpda2=self.webpackChunklpda2||[]).push([[2920],{2920:(S,N,v)=>{"use strict";v.d(N,{I:()=>R});var i=v(4496),E=v(1343),A=v(5657),l=v(1040),f=v(1128),o=v(1368),t=v(6856),n=v(3252),e=v(6772);let a=(()=>{class h extends e.A{constructor(){super("/cable"),this.consumerChange=new A.E,this.version=null,this.start()}openConnection(s,p){return new n._(C=>{if((0,i.sPQ)()&&console.log(`${this.constructor.name}.openConnection()`,{self:this,channel:s,data:p}),!this.consumer)return console.error(`${this.constructor.name}.openConnection() error: consumer is undefined`),void C.error();const O=()=>this.consumer.subscriptions.create(s,p);if(this.consumer)return C.next(O()),void C.complete();this.consumerChange.subscribe(I=>{I?C.next(O()):(console.error(`${this.constructor.name}.subscribeChannel() error: consumer is undefined`),C.error()),C.complete()},I=>{console.error(`${this.constructor.name}.subscribeChannel() error: consumerChange error`,I),C.error(I)},()=>{console.debug(`${this.constructor.name}.subscribeChannel() error: consumerChange complete`),C.complete()})})}closeConnection(s){this.consumer&&this.consumer.subscriptions.subscriptions.forEach(p=>{p.identifier==JSON.stringify(s)&&p.unsubscribe()})}start(){(0,i.sPQ)()&&console.log(`${this.constructor.name}.start()`,{self:this}),this.url().subscribe({next:s=>{this.consumer=t.createConsumer(s),this.consumer.connect(),this.consumerChange.next(this.consumer)}})}static#t=this.\u0275fac=function(p){return new(p||h)};static#e=this.\u0275prov=i.wxM({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})();var u=v(8304),m=v(1236),d=v(1512);function c(h,T){if(1&h&&(i.OEk(0),i.wVc(1,"date"),i.I0R(2,"a",0),i.SAx(3),i.aS0(4,1),i.k70(),i.C$Y()),2&h){const s=i.GaO();i.MjK(" Nuova prenotazione per ",s.reservation.people," persone per ",i.g7$(1,4,s.reservation.datetime,"dd/MM/yyyy HH:mm")," a nome ",s.reservation.fullname," "),i.yG2(2),i.CI5("routerLink","/admin/reservations/",s.reservation.id,"")}}let g=(()=>{class h{constructor(s){this.context=s,this.reservation=null,this.reservation=s.data?.reservation||null}static#t=this.\u0275fac=function(p){return new(p||h)(i.GI1(l.C0))};static#e=this.\u0275cmp=i.In1({type:h,selectors:[["app-reservation-created-notification"]],standalone:!0,features:[i.UHJ],decls:1,vars:1,consts:()=>{let s;return s="Details",[["tuiLink","",3,"routerLink"],s]},template:function(p,C){1&p&&i.yuY(0,c,5,7,"a",0),2&p&&i.C0Y(0,C.reservation?0:-1)},dependencies:[o.y,m.qQ,m.ER,d.w,d.C],encapsulation:2})}return h})();function y(h,T){if(1&h&&(i.OEk(0),i.wVc(1,"date"),i.I0R(2,"a",0),i.SAx(3),i.aS0(4,1),i.k70(),i.C$Y()),2&h){const s=i.GaO();i.MjK(" Prenotazione annullata per ",s.reservation.people," persone per ",i.g7$(1,4,s.reservation.datetime,"dd/MM/yyyy HH:mm")," a nome ",s.reservation.fullname," "),i.yG2(2),i.CI5("routerLink","/admin/reservations/",s.reservation.id,"")}}let b=(()=>{class h{constructor(s){this.context=s,this.reservation=null,this.reservation=s.data?.reservation||null}static#t=this.\u0275fac=function(p){return new(p||h)(i.GI1(l.C0))};static#e=this.\u0275cmp=i.In1({type:h,selectors:[["app-reservation-cancelled-notification"]],standalone:!0,features:[i.UHJ],decls:1,vars:1,consts:()=>{let s;return s="Details",[["tuiLink","",3,"routerLink"],s]},template:function(p,C){1&p&&i.yuY(0,y,5,7,"a",0),2&p&&i.C0Y(0,C.reservation?0:-1)},dependencies:[o.y,m.qQ,m.ER,d.w,d.C],encapsulation:2})}return h})(),R=(()=>{class h extends f.E{constructor(){super(),this.injector=(0,i.uUt)(i.zZn),this.ws=(0,i.uUt)(a),this.reservations=(0,i.uUt)(u.S),this.notifications=(0,i.uUt)(f.E),this.wsEvents=new A.E,this.date=(0,i.uUt)(o.y),this.listeningWsChanges=!1}listenWsChanges(){return this.listeningWsChanges||(this.notifyOnEvents(),this.listeningWsChanges=!0,this.ws.openConnection("ReservationsChannel",{received:s=>{this.wsEvents.next(s)}}).subscribe((0,E.I)())),this.wsEvents}manageReservationCreated(s){this.alertServiceFireComponent(g,s,"info")}manageReservationCancelled(s){this.alertServiceFireComponent(b,s,"warning")}notifyOnEvents(){this.wsEvents.subscribe(s=>{s.reservation_id&&("create"===s.action||"cancel"===s.action)&&this.reservations.show(s.reservation_id).subscribe(p=>{"create"===s.action?this.manageReservationCreated(p):"cancel"===s.action&&this.manageReservationCancelled(p)})})}alertServiceFireComponent(s,p,C){this.alertService.open(new l.WO(s,this.injector),{status:C,autoClose:!1,data:{reservation:p}}).subscribe()}static#t=this.\u0275fac=function(p){return new(p||h)};static#e=this.\u0275prov=i.wxM({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})()},6856:function(S,N,v){var i,E;(function(){(function(){(function(){var f=[].slice;this.ActionCable={INTERNAL:{message_types:{welcome:"welcome",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},WebSocket:window.WebSocket,logger:window.console,createConsumer:function(o){var t;return null==o&&(o=null!=(t=this.getConfig("url"))?t:this.INTERNAL.default_mount_path),new l.Consumer(this.createWebSocketURL(o))},getConfig:function(o){var t;return t=document.head.querySelector("meta[name='action-cable-"+o+"']"),t?.getAttribute("content")},createWebSocketURL:function(o){var t;return o&&!/^wss?:/i.test(o)?((t=document.createElement("a")).href=o,t.href=t.href,t.protocol=t.protocol.replace("http","ws"),t.href):o},startDebugging:function(){return this.debugging=!0},stopDebugging:function(){return this.debugging=null},log:function(){var o,t;if(o=1<=arguments.length?f.call(arguments,0):[],this.debugging)return o.push(Date.now()),(t=this.logger).log.apply(t,["[ActionCable]"].concat(f.call(o)))}}}).call(this)}).call(this);var l=this.ActionCable;(function(){(function(){l.ConnectionMonitor=function(){var o,t,n;function e(r){this.connection=r,this.visibilityDidChange=function(o,t){return function(){return o.apply(t,arguments)}}(this.visibilityDidChange,this),this.reconnectAttempts=0}return e.pollInterval={min:3,max:30},e.staleThreshold=6,e.prototype.start=function(){if(!this.isRunning())return this.startedAt=t(),delete this.stoppedAt,this.startPolling(),document.addEventListener("visibilitychange",this.visibilityDidChange),l.log("ConnectionMonitor started. pollInterval = "+this.getPollInterval()+" ms")},e.prototype.stop=function(){if(this.isRunning())return this.stoppedAt=t(),this.stopPolling(),document.removeEventListener("visibilitychange",this.visibilityDidChange),l.log("ConnectionMonitor stopped")},e.prototype.isRunning=function(){return null!=this.startedAt&&null==this.stoppedAt},e.prototype.recordPing=function(){return this.pingedAt=t()},e.prototype.recordConnect=function(){return this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,l.log("ConnectionMonitor recorded connect")},e.prototype.recordDisconnect=function(){return this.disconnectedAt=t(),l.log("ConnectionMonitor recorded disconnect")},e.prototype.startPolling=function(){return this.stopPolling(),this.poll()},e.prototype.stopPolling=function(){return clearTimeout(this.pollTimeout)},e.prototype.poll=function(){return this.pollTimeout=setTimeout(function(r){return function(){return r.reconnectIfStale(),r.poll()}}(this),this.getPollInterval())},e.prototype.getPollInterval=function(){var r,a,u,m;return u=(m=this.constructor.pollInterval).min,a=m.max,r=5*Math.log(this.reconnectAttempts+1),Math.round(1e3*o(r,u,a))},e.prototype.reconnectIfStale=function(){if(this.connectionIsStale())return l.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+this.reconnectAttempts+", pollInterval = "+this.getPollInterval()+" ms, time disconnected = "+n(this.disconnectedAt)+" s, stale threshold = "+this.constructor.staleThreshold+" s"),this.reconnectAttempts++,this.disconnectedRecently()?l.log("ConnectionMonitor skipping reopening recent disconnect"):(l.log("ConnectionMonitor reopening"),this.connection.reopen())},e.prototype.connectionIsStale=function(){var r;return n(null!=(r=this.pingedAt)?r:this.startedAt)>this.constructor.staleThreshold},e.prototype.disconnectedRecently=function(){return this.disconnectedAt&&n(this.disconnectedAt)<this.constructor.staleThreshold},e.prototype.visibilityDidChange=function(){if("visible"===document.visibilityState)return setTimeout(function(r){return function(){if(r.connectionIsStale()||!r.connection.isOpen())return l.log("ConnectionMonitor reopening stale connection on visibilitychange. visbilityState = "+document.visibilityState),r.connection.reopen()}}(this),200)},t=function(){return(new Date).getTime()},n=function(r){return(t()-r)/1e3},o=function(r,a,u){return Math.max(a,Math.min(u,r))},e}()}).call(this),function(){var o,t,n,e,a=[].slice,m=[].indexOf||function(d){for(var c=0,g=this.length;c<g;c++)if(c in this&&this[c]===d)return c;return-1};o=(n=l.INTERNAL).message_types,e=2<=(t=n.protocols).length?a.call(t,0,t.length-1):(0,[]),l.Connection=function(){function d(c){this.consumer=c,this.open=function(d,c){return function(){return d.apply(c,arguments)}}(this.open,this),this.subscriptions=this.consumer.subscriptions,this.monitor=new l.ConnectionMonitor(this),this.disconnected=!0}return d.reopenDelay=500,d.prototype.send=function(c){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(c)),!0)},d.prototype.open=function(){return this.isActive()?(l.log("Attempted to open WebSocket, but existing socket is "+this.getState()),!1):(l.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+t),null!=this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new l.WebSocket(this.consumer.url,t),this.installEventHandlers(),this.monitor.start(),!0)},d.prototype.close=function(c){var y;if((c??{allowReconnect:!0}).allowReconnect||this.monitor.stop(),this.isActive())return null!=(y=this.webSocket)?y.close():void 0},d.prototype.reopen=function(){if(l.log("Reopening WebSocket, current state is "+this.getState()),!this.isActive())return this.open();try{return this.close()}catch(g){return l.log("Failed to reopen WebSocket",g)}finally{l.log("Reopening WebSocket in "+this.constructor.reopenDelay+"ms"),setTimeout(this.open,this.constructor.reopenDelay)}},d.prototype.getProtocol=function(){var c;return null!=(c=this.webSocket)?c.protocol:void 0},d.prototype.isOpen=function(){return this.isState("open")},d.prototype.isActive=function(){return this.isState("open","connecting")},d.prototype.isProtocolSupported=function(){var c;return c=this.getProtocol(),m.call(e,c)>=0},d.prototype.isState=function(){var c,g;return g=1<=arguments.length?a.call(arguments,0):[],c=this.getState(),m.call(g,c)>=0},d.prototype.getState=function(){var c,g;for(g in WebSocket)if(WebSocket[g]===(null!=(c=this.webSocket)?c.readyState:void 0))return g.toLowerCase();return null},d.prototype.installEventHandlers=function(){var c,g;for(c in this.events)g=this.events[c].bind(this),this.webSocket["on"+c]=g},d.prototype.uninstallEventHandlers=function(){var c;for(c in this.events)this.webSocket["on"+c]=function(){}},d.prototype.events={message:function(c){var g,y,b,R;if(this.isProtocolSupported())switch(b=JSON.parse(c.data),g=b.identifier,y=b.message,R=b.type,R){case o.welcome:return this.monitor.recordConnect(),this.subscriptions.reload();case o.ping:return this.monitor.recordPing();case o.confirmation:return this.subscriptions.notify(g,"connected");case o.rejection:return this.subscriptions.reject(g);default:return this.subscriptions.notify(g,"received",y)}},open:function(){if(l.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol"),this.disconnected=!1,!this.isProtocolSupported())return l.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close:function(c){if(l.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error:function(){return l.log("WebSocket onerror event")}},d}()}.call(this),function(){var f=[].slice;l.Subscriptions=function(){function o(t){this.consumer=t,this.subscriptions=[]}return o.prototype.create=function(t,n){var e,a;return a=new l.Subscription(this.consumer,"object"==typeof(e=t)?e:{channel:e},n),this.add(a)},o.prototype.add=function(t){return this.subscriptions.push(t),this.consumer.ensureActiveConnection(),this.notify(t,"initialized"),this.sendCommand(t,"subscribe"),t},o.prototype.remove=function(t){return this.forget(t),this.findAll(t.identifier).length||this.sendCommand(t,"unsubscribe"),t},o.prototype.reject=function(t){var n,e,r,a,u;for(a=[],n=0,e=(r=this.findAll(t)).length;n<e;n++)this.forget(u=r[n]),this.notify(u,"rejected"),a.push(u);return a},o.prototype.forget=function(t){var n;return this.subscriptions=function(){var e,r,a,u;for(u=[],e=0,r=(a=this.subscriptions).length;e<r;e++)(n=a[e])!==t&&u.push(n);return u}.call(this),t},o.prototype.findAll=function(t){var n,e,r,a,u;for(a=[],n=0,e=(r=this.subscriptions).length;n<e;n++)(u=r[n]).identifier===t&&a.push(u);return a},o.prototype.reload=function(){var t,n,e,r;for(r=[],t=0,n=(e=this.subscriptions).length;t<n;t++)r.push(this.sendCommand(e[t],"subscribe"));return r},o.prototype.notifyAll=function(){var t,n,e,r,a,u;for(n=arguments[0],t=2<=arguments.length?f.call(arguments,1):[],u=[],e=0,r=(a=this.subscriptions).length;e<r;e++)u.push(this.notify.apply(this,[a[e],n].concat(f.call(t))));return u},o.prototype.notify=function(){var t,n,e,r,a,u,m;for(u=arguments[0],n=arguments[1],t=3<=arguments.length?f.call(arguments,2):[],a=[],e=0,r=(m="string"==typeof u?this.findAll(u):[u]).length;e<r;e++)a.push("function"==typeof(u=m[e])[n]?u[n].apply(u,t):void 0);return a},o.prototype.sendCommand=function(t,n){return this.consumer.send({command:n,identifier:t.identifier})},o}()}.call(this),function(){l.Subscription=function(){var f;function o(t,n,e){this.consumer=t,null==n&&(n={}),this.identifier=JSON.stringify(n),f(this,e)}return o.prototype.perform=function(t,n){return null==n&&(n={}),n.action=t,this.send(n)},o.prototype.send=function(t){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(t)})},o.prototype.unsubscribe=function(){return this.consumer.subscriptions.remove(this)},f=function(t,n){var e;if(null!=n)for(e in n)t[e]=n[e];return t},o}()}.call(this),function(){l.Consumer=function(){function f(o){this.url=o,this.subscriptions=new l.Subscriptions(this),this.connection=new l.Connection(this)}return f.prototype.send=function(o){return this.connection.send(o)},f.prototype.connect=function(){return this.connection.open()},f.prototype.disconnect=function(){return this.connection.close({allowReconnect:!1})},f.prototype.ensureActiveConnection=function(){if(!this.connection.isActive())return this.connection.open()},f}()}.call(this)}).call(this),S.exports?S.exports=l:void 0!==(E="function"==typeof(i=l)?i.call(N,v,N,S):i)&&(S.exports=E)}).call(this)}}]);